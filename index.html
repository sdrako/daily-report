<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ημερήσια Αναφορά</title>

  <style>
    body{margin:0;background:#f4f5f7;font-family:system-ui,Segoe UI,Roboto,Arial}
    .app{max-width:1100px;margin:auto;padding:16px}
    .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
    h1,h2,h3{margin:0 0 10px}
    .muted{color:#6b7280}
    .btn{border:0;border-radius:12px;padding:14px 16px;background:#111827;color:#fff;font-weight:700}
    .btn.secondary{background:#374151}
    .btn.ghost{background:transparent;color:#111827;border:1px solid #d1d5db}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #d1d5db;padding:8px;vertical-align:top}
    th{background:#e5e7eb;text-align:left}
    input,textarea,select{
      width:100%;border:1px solid #d1d5db;border-radius:8px;
      padding:8px;box-sizing:border-box
    }
    textarea{min-height:160px}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.split{grid-template-columns:1fr}}
    .pill{background:#eef2ff;color:#3730a3;padding:4px 8px;border-radius:999px;font-size:12px}
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:20px;
      background:#111827;color:#fff;padding:12px 16px;border-radius:12px;display:none;
      max-width:calc(100% - 24px);
    }
    .right{text-align:right}
    .overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(17,24,39,.72);
      z-index:9999;
    }
    .login-card{max-width:420px; width:calc(100% - 32px)}
    .input{
      width:100%; padding:12px 14px; border-radius:12px;
      border:1px solid #d1d5db; font-size:16px; margin:10px 0;
    }
    .row{display:flex; gap:10px; align-items:center}
    .error{
      margin-top:10px; color:#b91c1c; background:#fee2e2;
      border:1px solid #fecaca; padding:10px 12px; border-radius:12px;
    }
  </style>
</head>

<body>

<div class="app">

  <!-- HOME -->
  <section id="home" class="card">
    <h1>Ημερήσια Αναφορά</h1>
    <button class="btn" id="newBtn">Δημιουργία Νέας Αναφοράς</button>
    <div class="muted" style="margin-top:10px;font-size:12px;">
      Samsung tip: Save → Share → OneDrive → DailyReportsApp/exports.
    </div>
  </section>

  <!-- REPORT -->
  <section id="report" class="card" style="display:none">

    <div class="toolbar">
      <h2>Ημερήσια Αναφορά Υπογείων <span class="pill" id="statusPill"> v1.00 </span></h2>
      <span style="flex:1"></span>
      <button class="btn ghost" id="cancelBtn">Άκυρο</button>
      <button class="btn secondary" id="previewBtn">Προεπισκόπηση</button>
      <button class="btn" id="saveBtn">Αποθήκευση</button>
    </div>

    <div class="split" style="margin-top:12px">

      <!-- LEFT COLUMN -->
      <div>

        <!-- GENERAL -->
        <table>
          <tr><th style="width:220px;">Ημερομηνία</th><td><input type="date" id="date"></td></tr>
          <tr><th>Μήκος (m)</th><td><input type="number" id="length" step="10" min="0"></td></tr>
          <tr><th>Βάθος (m)</th><td><input type="number" id="depth" step="0.1" min="0"></td></tr>
          <tr><th>Εμπόδια</th><td><input type="text" id="obstacles"></td></tr>
          <tr><th>Διάβαση</th><td><input type="text" id="crossing"></td></tr>
          <tr><th>Ιδιομορφία εδάφους</th><td><input type="text" id="soil"></td></tr>
        </table>

        <!-- PERSONNEL -->
        <h3 style="margin-top:14px;">Προσωπικό</h3>
        <table id="personnelTable">
          <tr>
            <th>Όνομα</th>
            <th style="width:110px;">Άφιξη</th>
            <th style="width:110px;">Αναχώρηση</th>
          </tr>
        </table>

        <div class="toolbar" style="margin-top:8px;">
          <button class="btn ghost" id="addPersonBtn">+ Προσθήκη</button>
          <button class="btn ghost" id="resetPersonBtn">Reset</button>
        </div>

      </div>

      <!-- RIGHT COLUMN -->
      <div>

        <!-- MACHINES -->
        <h3>Μηχανήματα (ώρες)</h3>
        <table>
          <tr><th>Μηχάνημα</th><th style="width:160px;">Ώρες</th></tr>
          <tr><td>ΤΣΑΠΑΚΙ - ΣΦΥΡΙ</td><td><input type="number" id="m_hammer" step="1" min="0" placeholder="0"></td></tr>
          <tr><td>ΤΣΑΠΑΚΙ - ΚΟΥΒΑΣ</td><td><input type="number" id="m_bucket" step="1" min="0" placeholder="0"></td></tr>
          <tr><td>ΦΟΡΤΩΤΗΣ BOBCAT</td><td><input type="number" id="m_bobcat" step="1" min="0" placeholder="0"></td></tr>
        </table>

        <!-- TRUCKS -->
        <h3 style="margin-top:12px;">Φορτηγά με μπάζα</h3>
        <table>
          <tr><th>Αριθμός Φορτηγών</th></tr>
          <tr><td><input type="number" id="trucks" step="1" min="0" placeholder="0"></td></tr>
        </table>

        <!-- VEHICLES -->
        <h3 style="margin-top:12px;">Οχήματα</h3>
        <table id="vehiclesTable">
          <tr>
            <th>Όχημα</th>
            <th class="right" style="width:60px;">✔</th>
          </tr>
        </table>

        <div class="toolbar" style="margin-top:8px;">
          <button class="btn ghost" id="addVehicleBtn">+ Προσθήκη</button>
          <button class="btn ghost" id="resetVehicleBtn">Reset</button>
        </div>

      </div>
    </div>

    <!-- NOTES (FULL WIDTH, END) -->
    <h3 style="margin-top:14px;">Σημειώσεις</h3>
    <textarea id="notes" placeholder="Παρατηρήσεις, αποκλίσεις, αιτιολόγηση…"></textarea>

  </section>

  <div class="toast" id="toast"></div>
</div>

<script>
(() => {
  // Full lists (as provided earlier)
  const DEFAULT_PERSONNEL = [
    "PRENGA FLOVJAN",
    "ΝΙΚΟΛΑΣ ΜΠΛΛΟΣΜΙ",
    "ΣΕΜΠΑΣΤΙΑΝ ΠΡΕΝΓΚΑ",
    "HALILAJ TEDI",
    "ΓΚΟΥΜΑΣ ΣΟΦΙΑΝΟΣ",
    "ΝΤΕΡΒΙΣΗ ΑΛΕΞ",
    "ΦΩΤΟΠΟΥΛΟΣ ΛΑΜΠΡΟΣ",
    "ΝΤΟΥΜΟΣ ΚΩΝΣΤΑΝΤΙΝΟΣ",
    "ΤΖΑΦΕΡΙ ΑΛΜΠΡΙ",
    "ΣΑΡΚΙΣΙΑΝ ΡΟΒΕΡΤΟΣ",
    "ΠΑΥΛΟΠΟΥΛΟΣ ΣΤΑΘΗΣ",
    "PRENGA MARK",
    "SILO LULI",
    "ILIAS ELEZAJ",
    "KUJTIM KOLAJ",
    "ΜΠΟΣΙΝΗΣ ΝΙΚΟΛΑΟΣ",
    "ΔΗΜΗΤΡΗΣ ΠΑΡΝΑΣΑΣ"
  ];

  const DEFAULT_VEHICLES = [
    "ME161045 ISUZU JCB",
    "BMB3936 Mercedes ΤΡΑΚΤΟΡΑΣ",
    "TB82048 ΝΤΑΛΙΚΑ ΜΕΤΑΦΟΡΑΣ ΜΗΧ/ΩΝ",
    "ME144669 ΕΚΣΚΑΦΕΑΣ TAKEUSHI",
    "BKY6890 FORD TRANSIT",
    "TB82038 ΧΩΜΑΤΟΥΡΓΙΚΟ CARNEHL",
    "BMB3995 ACTROS 4ΞΟΝΙΚΟ",
    "ME167843 CATERPILLAR ΕΚΣΚ. ΦΟΡΤΩΤΗΣ",
    "ME167963 SV12 ΔΙΑΒΟΛΑΚΙ",
    "BKY6895 SPRINTER ΛΕΥΚΟ",
    "AZA1374 Mercedes ΓΕΡΑΝΟΣ ΠΟΡΤΟΚΑΛΙ",
    "BKY9689 SPRINTER ΚΙΤΡΙΝΟ",
    "ZYX4986 NISSAN NAVARA",
    "ME96857 Mitsubishi ΕΚΣΚΑΦΕΑΣ EΠΙ 3.5T",
    "PAE2616 Mitsubishi L200",
    "TKX9978 MAN ΦΟΡΤΗΓΟ ΜΠΛΕ",
    "BME1206 Mercedes ΠΡΑΣΙΝΟ 1846"
  ];

  const $ = (id) => document.getElementById(id);


  const home = $("home");
  const report = $("report");
  const toast = $("toast");
  const statusPill = $("statusPill");

  const dateEl = $("date");
  const lengthEl = $("length");
  const depthEl = $("depth");
  const obstaclesEl = $("obstacles");
  const crossingEl = $("crossing");
  const soilEl = $("soil");

  const mHammerEl = $("m_hammer");
  const mBucketEl = $("m_bucket");
  const mBobcatEl = $("m_bobcat");

  const trucksEl = $("trucks");
  const notesEl = $("notes");

  const personnelTable = $("personnelTable");
  const vehiclesTable = $("vehiclesTable");

  let personnel = [];
  let vehicles = [];

  function todayISO(){
    const d = new Date();
    const pad = (n) => String(n).padStart(2,"0");
    return d.getFullYear() + "-" + pad(d.getMonth()+1) + "-" + pad(d.getDate());
  }

  function showToast(msg){
    toast.textContent = msg;
    toast.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toast.style.display = "none", 3200);
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function numOrZero(v){
    const s = String(v ?? "").trim();
    if (!s) return 0;
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function intOrZero(v){
    return Math.max(0, Math.trunc(numOrZero(v)));
  }

  function markDirty(){
    if (statusPill.textContent !== "v1.00") statusPill.textContent = "v1.00";
  }

  [
    dateEl,lengthEl,depthEl,obstaclesEl,crossingEl,soilEl,
    mHammerEl,mBucketEl,mBobcatEl,trucksEl,notesEl
  ].forEach(el => el.addEventListener("input", markDirty));

  function renderPersonnel(){
    personnelTable.querySelectorAll("tr.data-row").forEach(r => r.remove());

    personnel.forEach((p, idx) => {
      const tr = document.createElement("tr");
      tr.className = "data-row";
      tr.innerHTML =
        "<td><input type='text' data-idx='" + idx + "' data-field='name' value='" + escapeHtml(p.name) + "'></td>" +
        "<td><input type='text' inputmode='numeric' pattern='^([01]\\d|2[0-3]):([0-5]\\d)$' placeholder='HH:MM' data-idx='" + idx + "' data-field='arrival' value='" + escapeHtml(p.arrival) + "'></td>" +
        "<td><input type='text' inputmode='numeric' pattern='^([01]\\d|2[0-3]):([0-5]\\d)$' placeholder='HH:MM' data-idx='" + idx + "' data-field='departure' value='" + escapeHtml(p.departure) + "'></td>";

        
      personnelTable.appendChild(tr);
    });

    personnelTable.querySelectorAll("input[data-field='arrival'], input[data-field='departure']")
    .forEach(inp => {
        inp.addEventListener("input", (e) => {
            const i = Number(e.target.dataset.idx);
            const f = e.target.dataset.field;

            const formatted = formatTimeInput(e.target.value);
            e.target.value = formatted;

            personnel[i][f] = formatted;
            markDirty();
        });
    });
  }

  function renderVehicles(){
    vehiclesTable.querySelectorAll("tr.data-row").forEach(r => r.remove());

    vehicles.forEach((v, idx) => {
      const tr = document.createElement("tr");
      tr.className = "data-row";
      tr.innerHTML =
        "<td><input type='text' data-vidx='" + idx + "' data-vfield='label' value='" + escapeHtml(v.label) + "'></td>" +
        "<td class='right'><input type='checkbox' data-vidx='" + idx + "' data-vfield='used' " + (v.used ? "checked" : "") + "></td>";
      vehiclesTable.appendChild(tr);
    });

    vehiclesTable.querySelectorAll("input[data-vidx]").forEach(inp => {
      inp.addEventListener("input", (e) => {
        const i = Number(e.target.getAttribute("data-vidx"));
        const f = e.target.getAttribute("data-vfield");
        if (f === "used") vehicles[i].used = e.target.checked;
        else vehicles[i].label = e.target.value;
        markDirty();
      });
    });
  }

  function resetPersonnelToDefault(){
    personnel = DEFAULT_PERSONNEL.map(name => ({ name, arrival:"", departure:"" }));
    renderPersonnel();
  }

  function resetVehiclesToDefault(){
    vehicles = DEFAULT_VEHICLES.map(label => ({ label, used:false }));
    renderVehicles();
  }

    function formatTimeInput(raw) {
  // Keep digits only
  let v = raw.replace(/\D/g, "").slice(0, 4);

  if (v.length === 0) return "";

  // 1–2 digits: just hours part (partial)
  if (v.length <= 2) return v;

  const hh = v.slice(0, 2);
  const mmRaw = v.slice(2); // 1 or 2 digits

  // Clamp hours even while partial
  let h = parseInt(hh, 10);
  if (!Number.isFinite(h)) h = 0;
  if (h > 23) h = 23;

  // 3 digits: show "HH:M" (no padding yet)
  if (v.length === 3) {
    const m1 = mmRaw; // single digit
    let m = parseInt(m1, 10);
    if (!Number.isFinite(m)) m = 0;
    if (m > 5) m = 5; // first minute digit cannot exceed 5
    return String(h).padStart(2, "0") + ":" + String(m);
  }

  // 4 digits: show "HH:MM" (now pad/validate fully)
  const mm = mmRaw; // two digits
  let m = parseInt(mm, 10);
  if (!Number.isFinite(m)) m = 0;
  if (m > 59) m = 59;

  return String(h).padStart(2, "0") + ":" + String(m).padStart(2, "0");
}


  function collectData(){
    return {
      meta: {
        created_at: new Date().toISOString(),
        app: "DailyReportsApp-local",
        version: 6
      },
      date: dateEl.value,
      length_m: lengthEl.value ? Number(lengthEl.value) : null,
      depth_m: depthEl.value ? Number(depthEl.value) : null,
      obstacles: obstaclesEl.value.trim(),
      crossing: crossingEl.value.trim(),
      soil_condition: soilEl.value,
      machines: {
        "ΤΣΑΠΑΚΙ - ΣΦΥΡΙ": Math.max(0, numOrZero(mHammerEl.value)),
        "ΤΣΑΠΑΚΙ - ΚΟΥΒΑΣ": Math.max(0, numOrZero(mBucketEl.value)),
        "ΦΟΡΤΩΤΗΣ BOBCAT": Math.max(0, numOrZero(mBobcatEl.value))
      },
      debris_trucks_loaded: intOrZero(trucksEl.value),
      personnel: personnel.map(p => ({ name: p.name, arrival: p.arrival, departure: p.departure })),
      vehicles: vehicles.map(v => ({ label: v.label, used: !!v.used })),
      notes: notesEl.value.trim()
    };
  }

  function makeFilename(data){
    const d = data.date || todayISO();
    return "daily_report_" + d + ".json";
  }

  function resetForm(){
    dateEl.value = todayISO();
    lengthEl.value = "";
    depthEl.value = "";
    obstaclesEl.value = "";
    crossingEl.value = "";
    soilEl.value = "";
    mHammerEl.value = "";
    mBucketEl.value = "";
    mBobcatEl.value = "";
    trucksEl.value = "";
    notesEl.value = "";

    resetPersonnelToDefault();
    resetVehiclesToDefault();

    statusPill.textContent = "v1.00";
  }

  async function saveReport(){
    const data = collectData();
    if (!data.date) { showToast("Συμπληρώστε ημερομηνία."); return; }

    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: "application/json" });
    const filename = makeFilename(data);

    try {
      if (navigator.canShare) {
        const file = new File([blob], filename, { type: blob.type });
        if (navigator.canShare({ files: [file] })) {
          await navigator.share({
            files: [file],
            title: "Daily report",
            text: "Upload to OneDrive → DailyReportsApp/exports"
          });
          statusPill.textContent = "Saved";
          showToast("Αποθηκεύτηκε. OneDrive → DailyReportsApp → exports.");
          report.style.display = "none";
          home.style.display = "block";
          return;
        }
      }
    } catch (e) {}

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(a.href);
      a.remove();
    }, 500);

    statusPill.textContent = "Saved";
    showToast("Αποθηκεύτηκε στα Downloads. Μεταφέρετέ το στο OneDrive → exports.");
    report.style.display = "none";
    home.style.display = "block";
  }

  function openPreview(){
    const d = collectData();
    const w = window.open("", "_blank");

    const machinesRows = Object.entries(d.machines || {}).map(([k,v]) =>
      "<tr><td>" + escapeHtml(k) + "</td><td>" + (v ?? 0) + "</td></tr>"
    ).join("");

    const personnelRows = (d.personnel || []).map(p =>
      "<tr><td>" + escapeHtml(p.name) + "</td><td>" + escapeHtml(p.arrival) + "</td><td>" + escapeHtml(p.departure) + "</td></tr>"
    ).join("");

    const vehiclesUsed = (d.vehicles || []).filter(v => v.used).map(v => "<li>" + escapeHtml(v.label) + "</li>").join("");

    const html =
      "<!doctype html><html lang='el'><head><meta charset='utf-8'>" +
      "<meta name='viewport' content='width=device-width, initial-scale=1'>" +
      "<title>Daily Report " + escapeHtml(d.date || '') + "</title>" +
      "<style>" +
      "body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;padding:16px;}" +
      "h1{margin:0 0 8px;}" +
      "table{width:100%;border-collapse:collapse;margin:10px 0;}" +
      "th,td{border:1px solid #999;padding:6px;vertical-align:top;}" +
      "th{background:#eee;text-align:left;}" +
      "</style></head><body>" +
      "<h1>Ημερήσια Αναφορά Υπογείων</h1>" +
      "<div><b>Ημερομηνία:</b> " + escapeHtml(d.date || "") + "</div>" +
      "<div><b>Μήκος:</b> " + (d.length_m ?? "") + " m</div>" +
      "<div><b>Βάθος:</b> " + (d.depth_m ?? "") + " m</div>" +
      "<div><b>Εμπόδια:</b> " + escapeHtml(d.obstacles || "") + "</div>" +
      "<div><b>Διάβαση:</b> " + escapeHtml(d.crossing || "") + "</div>" +
      "<div><b>Ιδιομορφία εδάφους:</b> " + escapeHtml(d.soil_condition || "") + "</div>" +

      "<h3>Μηχανήματα</h3>" +
      "<table><tr><th>Μηχάνημα</th><th>Ώρες</th></tr>" + machinesRows + "</table>" +

      "<div><b>Φορτηγά με μπάζα (φορτώσεις):</b> " + (d.debris_trucks_loaded ?? 0) + "</div>" +

      "<h3>Προσωπικό</h3>" +
      "<table><tr><th>Όνομα</th><th>Άφιξη</th><th>Αναχώρηση</th></tr>" + personnelRows + "</table>" +

      "<h3>Οχήματα (σε χρήση)</h3>" +
      "<ul>" + (vehiclesUsed || "<li>—</li>") + "</ul>" +

      "<h3>Σημειώσεις</h3>" +
      "<div style='white-space:pre-wrap;border:1px solid #999;padding:8px;'>" + escapeHtml(d.notes || "") + "</div>" +

      "<script>window.print();</" + "script>" +
      "</body></html>";

    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  function buildReportObject() {
    return {
      schemaVersion: 1,
      date: new Date().toISOString().slice(0, 10),
      site: "SITE_A",
      personnel: [],
      notes: ""
    };
  }

  function makeReportFilename(report) {
    // e.g. daily-report_2026-01-08_SITE_A.json
    return `daily-report_${report.date}_${report.site}.json`;
  }

  function downloadFile(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }

  async function shareReportJson(reportObj) {
    const jsonText = JSON.stringify(reportObj, null, 2);
    const blob = new Blob([jsonText], { type: "application/json" });
    const filename = makeReportFilename(reportObj);

    // Web Share API expects File objects for file sharing
    const file = new File([blob], filename, { type: "application/json" });

    const shareData = {
      title: "Daily Site Report",
      text: `Daily report ${reportObj.date} (${reportObj.site})`,
      files: [file]
    };

    // 1) Best case: share with files
    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
      try {
        await navigator.share(shareData);
        return true;
      } catch (err) {
        // User cancelled share, or share failed
        console.warn("Share failed/cancelled:", err);
        return false;
      }
    }

    // 2) If file sharing is not supported, try sharing without files (text only)
    if (navigator.share) {
      try {
        await navigator.share({
          title: shareData.title,
          text: shareData.text
          // You can also include url: location.href if useful
        });
        // Still download the file so they can upload manually
        downloadFile(blob, filename);
        return true;
      } catch (err) {
        console.warn("Share (no files) failed/cancelled:", err);
      }
    }

    // 3) Final fallback: download only
    downloadFile(blob, filename);
    return false;
  }

  // Wire UI
  $("newBtn").addEventListener("click", () => {
    resetForm();
    home.style.display = "none";
    report.style.display = "block";
  });

  $("cancelBtn").addEventListener("click", () => {
    report.style.display = "none";
    home.style.display = "block";
  });

  $("saveBtn").addEventListener("click", saveReport);
  $("previewBtn").addEventListener("click", openPreview);

  $("addPersonBtn").addEventListener("click", () => {
    personnel.push({ name:"", arrival:"", departure:"" });
    renderPersonnel();
    markDirty();
  });

  $("resetPersonBtn").addEventListener("click", () => {
    resetPersonnelToDefault();
    markDirty();
  });

  $("addVehicleBtn").addEventListener("click", () => {
    vehicles.push({ label:"", used:false });
    renderVehicles();
    markDirty();
  });

  $("resetVehicleBtn").addEventListener("click", () => {
    resetVehiclesToDefault();
    markDirty();
  });

  // initial state
  home.style.display = "block";
  report.style.display = "none";
})();
</script>

</body>
</html>
